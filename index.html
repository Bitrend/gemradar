<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CryptoSim Pro - Simulador de Trading de Criptomonedas</title>
  <meta name="description" content="Simulador de trading de criptomonedas con gráficos en tiempo real. Practica tus estrategias sin riesgo.">
  <meta name="keywords" content="simulador trading, criptomonedas, bitcoin, ethereum, trading sin riesgo">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    body {
      margin: 0;
      background: #0e1116;
      color: #fff;
      line-height: 1.6;
    }
    header {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      padding: 1em;
      text-align: center;
      font-size: 1.8em;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .controls, .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #1e2228;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    select, input, button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    select, input {
      background: #2c313a;
      color: #fff;
      border: 1px solid #3a434c;
    }
    button {
      background: linear-gradient(to right, #3a7bd5, #00d2ff);
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      min-width: 100px;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .chart {
      width: 100%;
      height: 500px;
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 25px;
    }
    .stat-box {
      background: #1e222d;
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .profit { color: #00ff9f; }
    .loss { color: #ff4d4d; }
    .neutral { color: #aaa; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: #1e222d;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #333;
    }
    th {
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #252a34;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #1e222d;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3a7bd5;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .settings-panel {
      background: #1e222d;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .settings-panel h3 {
      margin-top: 0;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    .settings-label {
      width: 150px;
      font-weight: bold;
    }
    .affiliate-banner {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      padding: 15px;
      border-radius: 8px;
      margin: 25px 0;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .affiliate-banner h3 {
      margin-top: 0;
      color: #1e222d;
    }
    .premium-feature {
      position: relative;
    }
    .premium-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: gold;
      color: #000;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.7em;
      font-weight: bold;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
<header>CryptoSim Pro</header>

<div class="container">
  <div class="stats">
    <div class="stat-box">
      <div>Balance</div>
      <div class="balance">$<span id="balance">20000.00</span></div>
    </div>
    <div class="stat-box">
      <div>Ganancias/Pérdidas</div>
      <div class="profit-loss neutral" id="profit-loss">+$0.00</div>
    </div>
    <div class="stat-box">
      <div>Tiempo Restante</div>
      <div class="timer" id="timer">0s</div>
    </div>
    <div class="stat-box">
      <div>Operaciones</div>
      <div id="trade-count">0</div>
    </div>
  </div>

  <button id="settings-toggle" onclick="toggleSettings()">⚙️ Configuración</button>
  
  <div class="settings-panel" id="settings-panel">
    <h3>Configuración de Simulación</h3>
    <div class="settings-row">
      <div class="settings-label">Volatilidad:</div>
      <select id="volatility">
        <option value="0.1">Baja (10%)</option>
        <option value="0.2" selected>Media (20%)</option>
        <option value="0.4">Alta (40%)</option>
        <option value="0.6">Extrema (60%)</option>
      </select>
    </div>
    <div class="settings-row">
      <div class="settings-label">Duración Operación:</div>
      <select id="trade-duration">
        <option value="5">5 segundos</option>
        <option value="10" selected>10 segundos</option>
        <option value="30">30 segundos</option>
        <option value="60">1 minuto</option>
      </select>
    </div>
    <div class="settings-row">
      <div class="settings-label">Probabilidad de Éxito:</div>
      <select id="win-probability">
        <option value="0.4">40%</option>
        <option value="0.5" selected>50%</option>
        <option value="0.6">60%</option>
        <option value="0.7">70%</option>
      </select>
    </div>
    <div class="settings-row">
      <div class="settings-label premium-feature">
        <span>Modo Realista <span class="premium-badge">PREMIUM</span></span>
        <div class="tooltip">?
          <span class="tooltiptext">Simula spreads y slippage como en mercados reales</span>
        </div>
      </div>
      <input type="checkbox" id="realistic-mode" disabled>
    </div>
  </div>

  <div class="controls">
    <label for="crypto-select">Seleccionar Cripto:</label>
    <select id="crypto-select">
      <option value="BINANCE:BTCUSDT">Bitcoin (BTC)</option>
      <option value="BINANCE:ETHUSDT">Ethereum (ETH)</option>
      <option value="BINANCE:BNBUSDT">Binance Coin (BNB)</option>
      <option value="BINANCE:XRPUSDT">Ripple (XRP)</option>
      <option value="BINANCE:SOLUSDT">Solana (SOL)</option>
    </select>
    
    <label for="timeframe">Timeframe:</label>
    <select id="timeframe">
      <option value="1">1 minuto</option>
      <option value="3">3 minutos</option>
      <option value="5" selected>5 minutos</option>
      <option value="15">15 minutos</option>
      <option value="60">1 hora</option>
    </select>
    
    <button onclick="showModal('deposit-modal')">Depositar</button>
    <button onclick="showModal('withdraw-modal')">Retirar</button>
    <button onclick="resetAccount()">Reiniciar</button>
  </div>

  <div class="chart" id="tradingview-widget-container"></div>

  <div class="actions">
    <input type="number" placeholder="Monto a operar (min $10)" id="trade-amount" min="10" step="10">
    <button id="buy-btn" onclick="buy()">Comprar (LONG)</button>
    <button id="sell-btn" onclick="sell()">Vender (SHORT)</button>
    <button id="cancel-btn" onclick="cancelTrade()" disabled>Cancelar</button>
  </div>

  <div class="affiliate-banner">
    <h3>¿Quieres operar con criptomonedas reales?</h3>
    <p>Regístrate en Binance usando nuestro enlace y recibe un 10% de descuento en comisiones:</p>
    <a href="https://www.binance.com" target="_blank" style="color: #1e222d; font-weight: bold;">👉 Regístrate ahora en Binance 👈</a>
    <p><small>También recomendamos estos libros para aprender trading:</small></p>
    <a href="https://www.amazon.com" target="_blank" style="color: #1e222d;">📚 Ver libros recomendados en Amazon</a>
  </div>

  <h2>Historial de Operaciones</h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Cripto</th>
        <th>Monto</th>
        <th>Resultado</th>
        <th>Estado</th>
        <th>Hora</th>
        <th>Duración</th>
      </tr>
    </thead>
    <tbody id="history-table">
      <!-- Historial se llena dinámicamente -->
    </tbody>
  </table>
</div>

<!-- Modales -->
<div id="deposit-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="hideModal('deposit-modal')">&times;</span>
    <h2>Depositar Fondos</h2>
    <p>Ingresa la cantidad que deseas depositar a tu cuenta de simulación:</p>
    <input type="number" id="deposit-amount" placeholder="Monto (min $100)" min="100">
    <button onclick="deposit()">Confirmar Depósito</button>
  </div>
</div>

<div id="withdraw-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="hideModal('withdraw-modal')">&times;</span>
    <h2>Retirar Fondos</h2>
    <p>Ingresa la cantidad que deseas retirar de tu cuenta de simulación:</p>
    <input type="number" id="withdraw-amount" placeholder="Monto disponible" min="10">
    <button onclick="withdraw()">Confirmar Retiro</button>
  </div>
</div>

<div id="trade-modal" class="modal">
  <div class="modal-content">
    <div class="loader"></div>
    <h2 id="trade-modal-title">Procesando Operación</h2>
    <p id="trade-modal-text">Por favor espera...</p>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  // Variables de estado
  let selectedSymbol = document.getElementById("crypto-select").value;
  let chartWidget;
  let balance = parseFloat(localStorage.getItem('balance')) || 20000;
  let currentStake = 0;
  let tradeRunning = false;
  let profitOrLoss = 0;
  let tradeId = parseInt(localStorage.getItem('tradeId')) || 1;
  let timerInterval = null;
  let secondsLeft = 0;
  let tradeStartTime = null;
  let tradeCount = parseInt(localStorage.getItem('tradeCount')) || 0;

  // Elementos del DOM
  const balanceDisplay = document.getElementById("balance");
  const profitLossDisplay = document.getElementById("profit-loss");
  const timerDisplay = document.getElementById("timer");
  const tradeCountDisplay = document.getElementById("trade-count");
  const buyBtn = document.getElementById("buy-btn");
  const sellBtn = document.getElementById("sell-btn");
  const cancelBtn = document.getElementById("cancel-btn");

  // Configuración inicial
  document.addEventListener('DOMContentLoaded', () => {
    updateBalance();
    loadChart(selectedSymbol, '5');
    updateTradeCount();
    
    // Cargar historial desde localStorage
    const savedHistory = localStorage.getItem('tradeHistory');
    if (savedHistory) {
      document.getElementById("history-table").innerHTML = savedHistory;
    }
  });

  // Funciones de utilidad
  function updateBalance() {
    balanceDisplay.textContent = balance.toFixed(2);
    localStorage.setItem('balance', balance);
  }

  function updateTradeCount() {
    tradeCountDisplay.textContent = tradeCount;
    localStorage.setItem('tradeCount', tradeCount);
  }

  function showProfitLoss(text, isProfit = null) {
    profitLossDisplay.textContent = text;
    profitLossDisplay.className = "profit-loss " + 
      (isProfit === true ? "profit" : 
       isProfit === false ? "loss" : "neutral");
  }

  function addHistory(status) {
    const table = document.getElementById("history-table");
    const row = table.insertRow(0);
    
    const duration = tradeStartTime ? 
      Math.floor((new Date() - tradeStartTime) / 1000) + 's' : 'N/A';
    
    const rowContent = `
      <td>${tradeId}</td>
      <td>${selectedSymbol.split(":")[1]}</td>
      <td>$${currentStake.toFixed(2)}</td>
      <td>${profitOrLoss >= 0 ? '+' : '-'}$${Math.abs(profitOrLoss).toFixed(2)}</td>
      <td>${status}</td>
      <td>${new Date().toLocaleTimeString()}</td>
      <td>${duration}</td>
    `;
    
    // Usamos textContent para evitar XSS
    row.innerHTML = rowContent;
    
    // Guardar en localStorage
    localStorage.setItem('tradeHistory', table.innerHTML);
    localStorage.setItem('tradeId', tradeId + 1);
    
    tradeId++;
    tradeCount++;
    updateTradeCount();
  }

  function loadChart(symbol, interval) {
    if (chartWidget && chartWidget !== undefined) {
      // Si el widget ya existe, solo actualizamos el símbolo e intervalo
      chartWidget.setSymbol(symbol, interval, () => {
        console.log(`Gráfico actualizado a ${symbol} con intervalo ${interval}`);
      });
      return;
    }
    
    // Si no existe, lo creamos
    document.getElementById("tradingview-widget-container").innerHTML = "";
    chartWidget = new TradingView.widget({
      "width": "100%",
      "height": 500,
      "symbol": symbol,
      "interval": interval,
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#1e222d",
      "enable_publishing": false,
      "hide_legend": false,
      "save_image": false,
      "container_id": "tradingview-widget-container"
    });
  }

  function toggleSettings() {
    const panel = document.getElementById("settings-panel");
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  }

  function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
  }

  function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  function showTradeModal(title, text) {
    document.getElementById("trade-modal-title").textContent = title;
    document.getElementById("trade-modal-text").textContent = text;
    document.getElementById("trade-modal").style.display = 'flex';
  }

  function hideTradeModal() {
    document.getElementById("trade-modal").style.display = 'none';
  }

  function startTimer(seconds, callback) {
    clearInterval(timerInterval);
    secondsLeft = seconds;
    timerDisplay.textContent = `${secondsLeft}s`;
    tradeStartTime = new Date();

    timerInterval = setInterval(() => {
      secondsLeft--;
      timerDisplay.textContent = `${secondsLeft}s`;
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        callback();
      }
    }, 1000);
  }

  function calculateTradeResult(stake) {
    const volatility = parseFloat(document.getElementById("volatility").value);
    const winProbability = parseFloat(document.getElementById("win-probability").value);
    
    const isWin = Math.random() < winProbability;
    const randomFactor = 0.5 + Math.random() * 0.5; // Entre 0.5 y 1.0
    
    if (isWin) {
      return stake * volatility * randomFactor; // Ganancia
    } else {
      return -stake * volatility * randomFactor * 1.2; // Pérdida (20% mayor que ganancia potencial)
    }
  }

  // Funciones principales
  function buy() {
    if (tradeRunning) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Operación en Curso";
      document.getElementById("trade-modal-text").textContent = "Ya tienes una operación activa. Finalízala antes de abrir otra.";
      return;
    }
    
    const stake = parseFloat(document.getElementById("trade-amount").value);
    const minStake = 10;
    
    if (!stake || isNaN(stake) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Monto Inválido";
      document.getElementById("trade-modal-text").textContent = "Por favor ingresa un monto válido para operar.";
      return;
    }
    
    if (stake < minStake) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Monto Mínimo";
      document.getElementById("trade-modal-text").textContent = `El monto mínimo para operar es $${minStake}.`;
      return;
    }
    
    if (stake > balance) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Fondos Insuficientes";
      document.getElementById("trade-modal-text").textContent = "No tienes suficiente saldo para esta operación.";
      return;
    }

    currentStake = stake;
    balance -= stake;
    updateBalance();

    showProfitLoss("Operación en progreso...", null);
    tradeRunning = true;
    buyBtn.disabled = true;
    sellBtn.disabled = true;
    cancelBtn.disabled = false;

    const duration = parseInt(document.getElementById("trade-duration").value);
    showTradeModal("Ejecutando Compra", `Operación LONG en ${selectedSymbol.split(":")[1]} por $${stake.toFixed(2)}`);

    setTimeout(() => {
      hideTradeModal();
      profitOrLoss = calculateTradeResult(stake);
      showProfitLoss(`Operación lista. Puedes Cerrar o Cancelar ahora.`, profitOrLoss >= 0);
      sellBtn.disabled = false;
    }, 2000);

    startTimer(duration, () => {
      if (tradeRunning) {
        showProfitLoss(`Tiempo agotado! Cierra o cancela la operación.`, null);
      }
    });
  }

  function sell() {
    if (!tradeRunning) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Sin Operación";
      document.getElementById("trade-modal-text").textContent = "No hay ninguna operación activa para cerrar.";
      return;
    }

    clearInterval(timerInterval);
    timerDisplay.textContent = "0s";

    const result = currentStake + profitOrLoss;
    balance += result;
    updateBalance();

    const resultText = profitOrLoss >= 0 
      ? `Ganancia: +$${profitOrLoss.toFixed(2)}`
      : `Pérdida: -$${Math.abs(profitOrLoss).toFixed(2)}`;
    
    showProfitLoss(resultText, profitOrLoss >= 0);
    addHistory("Cerrada");

    showTradeModal("Operación Cerrada", resultText);
    setTimeout(hideTradeModal, 2000);

    currentStake = 0;
    profitOrLoss = 0;
    tradeRunning = false;
    buyBtn.disabled = false;
    sellBtn.disabled = true;
    cancelBtn.disabled = true;
  }

  function cancelTrade() {
    if (!tradeRunning) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Sin Operación";
      document.getElementById("trade-modal-text").textContent = "No hay ninguna operación activa para cancelar.";
      return;
    }

    clearInterval(timerInterval);
    timerDisplay.textContent = "0s";

    let resultText;
    if (profitOrLoss === 0) {
      balance += currentStake;
      resultText = "Operación cancelada. Monto reembolsado.";
      showProfitLoss(resultText, null);
    } else {
      const result = currentStake + profitOrLoss;
      balance += result;
      resultText = profitOrLoss >= 0 
        ? `Ganancia (al cancelar): +$${profitOrLoss.toFixed(2)}`
        : `Pérdida (al cancelar): -$${Math.abs(profitOrLoss).toFixed(2)}`;
      showProfitLoss(resultText, profitOrLoss >= 0);
    }

    updateBalance();
    addHistory("Cancelada");

    showTradeModal("Operación Cancelada", resultText);
    setTimeout(hideTradeModal, 2000);

    currentStake = 0;
    profitOrLoss = 0;
    tradeRunning = false;
    buyBtn.disabled = false;
    sellBtn.disabled = true;
    cancelBtn.disabled = true;
  }

  function deposit() {
    const amount = parseFloat(document.getElementById("deposit-amount").value);
    if (!amount || amount < 100) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Monto Inválido";
      document.getElementById("trade-modal-text").textContent = "El monto mínimo para depósito es $100.";
      return;
    }

    balance += amount;
    updateBalance();
    hideModal('deposit-modal');

    showTradeModal("Depósito Exitoso", `Se depositaron $${amount.toFixed(2)} en tu cuenta.`);
    setTimeout(hideTradeModal, 2000);
  }

  function withdraw() {
    const amount = parseFloat(document.getElementById("withdraw-amount").value);
    if (!amount || amount < 10) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Monto Inválido";
      document.getElementById("trade-modal-text").textContent = "El monto mínimo para retiro es $10.";
      return;
    }

    if (amount > balance) {
      showModal('trade-modal');
      document.getElementById("trade-modal-title").textContent = "Fondos Insuficientes";
      document.getElementById("trade-modal-text").textContent = "No tienes suficiente saldo para este retiro.";
      return;
    }

    balance -= amount;
    updateBalance();
    hideModal('withdraw-modal');

    showTradeModal("Retiro Exitoso", `Se retiraron $${amount.toFixed(2)} de tu cuenta.`);
    setTimeout(hideTradeModal, 2000);
  }

  function resetAccount() {
    if (confirm("¿Estás seguro de que quieres reiniciar tu cuenta? Perderás todo tu historial y saldo.")) {
      balance = 20000;
      tradeId = 1;
      tradeCount = 0;
      document.getElementById("history-table").innerHTML = "";
      updateBalance();
      updateTradeCount();
      localStorage.clear();
      
      showTradeModal("Cuenta Reiniciada", "Tu cuenta ha sido restablecida a los valores iniciales.");
      setTimeout(hideTradeModal, 2000);
    }
  }

  // Event listeners
  document.getElementById("crypto-select").addEventListener("change", function() {
    selectedSymbol = this.value;
    const timeframe = document.getElementById("timeframe").value;
    loadChart(selectedSymbol, timeframe);
  });

  document.getElementById("timeframe").addEventListener("change", function() {
    const timeframe = this.value;
    loadChart(selectedSymbol, timeframe);
  });
</script>
</body>
</html>
