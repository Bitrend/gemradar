<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CryptoSim Pro - Simulador de Trading</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      margin: 0;
      background: #0e1116;
      color: #fff;
    }
    header {
      background-color: #1e2228;
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
    }
    .container {
      padding: 20px;
    }
    .controls, .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    select, input, button {
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
    button {
      background-color: #3a8dd8;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #337ac4;
    }
    .chart {
      width: 100%;
      height: 500px;
      margin-bottom: 30px;
    }
    .balance, .profit-loss, .timer {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    .profit { color: #00ff9f; }
    .loss { color: #ff4d4d; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: #1e222d;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #333;
    }
    th {
      background-color: #2c313a;
    }
    .exchange-links {
      margin: 20px 0;
      padding: 15px;
      background: #1e2228;
      border-radius: 5px;
    }
    .exchange-links h3 {
      text-align: center;
    }
    .exchange-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .exchange-card {
      background: #2c313a;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
<header>CryptoSim Pro</header>

<div class="container">
  <div class="balance">Balance: $<span id="balance">20000.00</span></div>
  <div class="timer" id="timer">Timer: 0s</div>

  <div class="controls">
    <label for="crypto-select">Choose Coin:</label>
    <select id="crypto-select">
      <option value="BINANCE:BTCUSDT">Bitcoin (BTC)</option>
      <option value="BINANCE:ETHUSDT">Ethereum (ETH)</option>
      <option value="BINANCE:BNBUSDT">Binance Coin (BNB)</option>
      <option value="BINANCE:XRPUSDT">Ripple (XRP)</option>
    </select>
    <button onclick="deposit()">Deposit</button>
    <button onclick="withdraw()">Withdraw</button>
  </div>

  <div class="chart" id="tradingview-widget-container"></div>

  <div class="actions">
    <input type="number" placeholder="Stake Amount (min $1)" id="trade-amount" min="1">
    <button onclick="buy()">Buy</button>
    <button onclick="sell()">Sell</button>
    <button onclick="cancelTrade()">Cancel Trade</button>
  </div>

  <div class="profit-loss" id="profit-loss"></div>

  <div class="exchange-links">
    <h3>Opera en estos exchanges (Enlaces de afiliado):</h3>
    <div class="exchange-grid">
      <div class="exchange-card">
        <a href="https://www.binance.com" target="_blank">Binance</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.coinbase.com" target="_blank">Coinbase</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.kraken.com" target="_blank">Kraken</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.kucoin.com" target="_blank">KuCoin</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.bybit.com" target="_blank">Bybit</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.okx.com" target="_blank">OKX</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.huobi.com" target="_blank">Huobi</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.gate.io" target="_blank">Gate.io</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.bitfinex.com" target="_blank">Bitfinex</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.bitmex.com" target="_blank">BitMEX</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.bitget.com" target="_blank">Bitget</a>
      </div>
      <div class="exchange-card">
        <a href="https://www.phemex.com" target="_blank">Phemex</a>
      </div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Coin</th>
        <th>Stake</th>
        <th>Result</th>
        <th>Status</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="history-table">
      <!-- History rows go here -->
    </tbody>
  </table>
</div>

<!-- Script de TradingView con carga asíncrona -->
<script>
  (function() {
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.async = true;
    script.onload = initTradingView;
    document.head.appendChild(script);
  })();

  function initTradingView() {
    new TradingView.widget({
      "autosize": true,
      "symbol": "BINANCE:BTCUSDT",
      "interval": "5",
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#1e222d",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "container_id": "tradingview-widget-container"
    });
  }
</script>

<script>
  'use strict';
  
  let selectedSymbol = document.getElementById("crypto-select").value;
  let balance = 20000;
  let currentStake = 0;
  let tradeRunning = false;
  let profitOrLoss = 0;
  let tradeId = 1;
  let timerInterval = null;
  let secondsLeft = 0;

  const balanceDisplay = document.getElementById("balance");
  const profitLossDisplay = document.getElementById("profit-loss");
  const timerDisplay = document.getElementById("timer");

  function updateBalance() {
    balanceDisplay.textContent = balance.toFixed(2);
  }

  function showProfitLoss(text, isProfit = true) {
    profitLossDisplay.textContent = text;
    profitLossDisplay.className = isProfit ? "profit-loss profit" : "profit-loss loss";
  }

  function addHistory(status) {
    const table = document.getElementById("history-table");
    const row = table.insertRow(0);
    row.innerHTML = `
      <td>${tradeId++}</td>
      <td>${selectedSymbol.split(":")[1]}</td>
      <td>$${currentStake.toFixed(2)}</td>
      <td>${profitOrLoss >= 0 ? '+' : '-'}$${Math.abs(profitOrLoss).toFixed(2)}</td>
      <td>${status}</td>
      <td>${new Date().toLocaleTimeString()}</td>
    `;
  }

  document.getElementById("crypto-select").addEventListener("change", function() {
    selectedSymbol = this.value;
    if (typeof TradingView !== 'undefined') {
      // Actualizar el símbolo en el gráfico existente
      const widget = document.getElementById("tradingview-widget-container").querySelector('iframe').contentWindow;
      widget.postMessage({
        frame_id: 'tradingview-widget-container',
        symbol: selectedSymbol
      }, '*');
    }
  });

  function deposit() {
    const amount = parseFloat(prompt("Enter deposit amount (min $100):", "100"));
    if (amount && amount >= 100) {
      balance += amount;
      updateBalance();
      alert(`Successfully deposited $${amount.toFixed(2)}`);
    }
  }

  function withdraw() {
    const amount = parseFloat(prompt("Enter withdrawal amount:", "10"));
    if (amount && amount >= 10 && amount <= balance) {
      balance -= amount;
      updateBalance();
      alert(`Successfully withdrew $${amount.toFixed(2)}`);
    }
  }

  function startTimer(seconds, callback) {
    secondsLeft = seconds;
    timerDisplay.textContent = `Timer: ${secondsLeft}s`;

    timerInterval = setInterval(() => {
      secondsLeft--;
      timerDisplay.textContent = `Timer: ${secondsLeft}s`;
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        callback();
      }
    }, 1000);
  }

  function buy() {
    if (tradeRunning) return alert("Finish current trade first.");
    const stake = parseFloat(document.getElementById("trade-amount").value);
    if (!stake || stake <= 0 || stake > balance) {
      return alert("Invalid stake amount.");
    }

    currentStake = stake;
    balance -= stake;
    updateBalance();

    showProfitLoss("Trade running...", true);
    tradeRunning = true;

    startTimer(5, () => {
      profitOrLoss = Math.random() > 0.5 ? stake * 0.2 : -stake * 0.3;
      showProfitLoss(`Trade ready. You may Sell or Cancel now.`, profitOrLoss >= 0);
    });
  }

  function sell() {
    if (!tradeRunning) return alert("No trade to sell.");
    clearInterval(timerInterval);
    timerDisplay.textContent = "Timer: 0s";

    const result = currentStake + profitOrLoss;
    balance += result;
    updateBalance();

    const resultText = profitOrLoss >= 0 
      ? `Profit: $${profitOrLoss.toFixed(2)}`
      : `Loss: $${Math.abs(profitOrLoss).toFixed(2)}`;
    
    showProfitLoss(resultText, profitOrLoss >= 0);
    addHistory("Closed");

    currentStake = 0;
    profitOrLoss = 0;
    tradeRunning = false;
  }

  function cancelTrade() {
    if (!tradeRunning) return alert("No active trade to cancel.");
    clearInterval(timerInterval);
    timerDisplay.textContent = "Timer: 0s";

    if (profitOrLoss === 0) {
      balance += currentStake;
      showProfitLoss("Trade cancelled. Stake refunded.");
    } else {
      const result = currentStake + profitOrLoss;
      balance += result;
      showProfitLoss(
        profitOrLoss >= 0 
          ? `Profit (on cancel): $${profitOrLoss.toFixed(2)}`
          : `Loss (on cancel): $${Math.abs(profitOrLoss).toFixed(2)}`,
        profitOrLoss >= 0
      );
    }

    updateBalance();
    addHistory("Cancelled");
    currentStake = 0;
    profitOrLoss = 0;
    tradeRunning = false;
  }
</script>
</body>
</html>
